# 用户认证系统使用指南

## 概述

备份服务现已支持用户注册和登录功能，实现了完整的用户数据隔离。每个用户只能访问和管理自己的备份任务、凭据和日志。

## 功能特性

### 🔐 用户认证
- **用户注册**: 新用户可以自主注册账户
- **用户登录**: 支持用户名密码登录
- **会话管理**: JWT令牌认证，安全可靠
- **自动登录**: 记住登录状态，无需重复登录

### 🏠 数据隔离
- **备份任务隔离**: 每个用户只能看到自己的备份任务
- **凭据隔离**: 用户凭据完全隔离，确保安全
- **日志隔离**: 备份日志按用户分离
- **统计数据隔离**: 仪表板统计仅显示用户自己的数据

### 🌍 国际化支持
- **默认中文**: 系统默认显示中文界面
- **双语支持**: 支持中文/英文切换
- **本地化存储**: 语言偏好自动保存

## 快速开始

### 1. 数据库迁移

如果您是从旧版本升级，需要运行数据库迁移：

```bash
# 设置管理员密码（必需）
export ADMIN_PASSWORD="your_admin_password"

# 运行迁移脚本
npm run migrate
```

迁移脚本会：
- 创建管理员账户
- 为现有数据添加用户关联
- 创建必要的数据库索引

### 2. 启动服务

```bash
# 启动服务
npm start

# 或使用开发模式
npm run dev
```

### 3. 访问系统

- **主界面**: http://localhost:3001
- **登录页面**: http://localhost:3001/login.html
- **注册页面**: http://localhost:3001/register.html

## 用户操作指南

### 注册新账户

1. 访问注册页面：http://localhost:3001/register.html
2. 填写注册信息：
   - **用户名**: 3-30个字符，只能包含字母、数字和下划线
   - **密码**: 至少6个字符
   - **确认密码**: 必须与密码一致
3. 点击"注册账户"按钮
4. 注册成功后自动跳转到主界面

### 用户登录

1. 访问登录页面：http://localhost:3001/login.html
2. 输入用户名和密码
3. 点击"登录"按钮
4. 登录成功后跳转到仪表板

### 退出登录

1. 点击右上角用户名下拉菜单
2. 选择"退出登录"
3. 确认后返回登录页面

## 管理员账户

### 默认管理员

系统会自动创建管理员账户：
- **用户名**: `admin`（可通过环境变量 `ADMIN_USERNAME` 修改）
- **密码**: 通过环境变量 `ADMIN_PASSWORD` 设置

### 环境变量配置

```bash
# 管理员用户名（可选，默认为 admin）
ADMIN_USERNAME=admin

# 管理员密码（必需）
ADMIN_PASSWORD=your_secure_password
```

## API 变更

### 认证头

所有API请求现在需要包含认证头：

```javascript
Authorization: Bearer <jwt_token>
```

### 新增API端点

#### 用户注册
```http
POST /api/auth/register
Content-Type: application/json

{
  "username": "newuser",
  "password": "password123",
  "confirmPassword": "password123"
}
```

#### 用户登录
```http
POST /api/auth/login
Content-Type: application/json

{
  "username": "user",
  "password": "password"
}
```

#### 退出登录
```http
POST /api/auth/logout
Authorization: Bearer <jwt_token>
```

### 数据隔离

所有数据相关的API现在会自动根据用户身份过滤数据：

- `GET /api/tasks` - 只返回当前用户的任务
- `GET /api/logs` - 只返回当前用户的日志
- `GET /api/credentials` - 只返回当前用户的凭据
- `GET /api/dashboard/overview` - 只显示当前用户的统计数据

## 安全特性

### 密码安全
- 使用 bcrypt 进行密码哈希
- 密码强度验证
- 防止密码明文存储

### 会话安全
- JWT 令牌认证
- 令牌自动过期
- 安全的会话管理

### 数据保护
- 用户数据完全隔离
- 访问权限验证
- 防止数据泄露

## 界面优化

### 现代化设计
- **毛玻璃效果**: 登录和注册页面使用现代毛玻璃设计
- **渐变背景**: 美观的渐变色彩方案
- **动画效果**: 流畅的页面过渡和交互动画
- **响应式设计**: 完美适配桌面和移动设备

### 用户体验
- **浮动标签**: 现代化的表单输入体验
- **实时验证**: 表单字段实时验证反馈
- **错误提示**: 友好的错误信息显示
- **加载状态**: 清晰的加载状态指示

### 无障碍支持
- **键盘导航**: 完整的键盘导航支持
- **屏幕阅读器**: 支持屏幕阅读器
- **焦点管理**: 清晰的焦点指示
- **语义化标签**: 正确的HTML语义结构

## 故障排除

### 常见问题

#### 1. 无法访问主界面
**问题**: 访问主界面时自动跳转到登录页面
**解决**: 这是正常行为，需要先登录才能访问主界面

#### 2. 注册失败
**问题**: 注册时提示用户名已存在
**解决**: 更换一个不同的用户名

#### 3. 登录失败
**问题**: 提示用户名或密码错误
**解决**: 检查用户名和密码是否正确，注意大小写

#### 4. 数据迁移失败
**问题**: 运行迁移脚本时出错
**解决**: 确保设置了 `ADMIN_PASSWORD` 环境变量

### 日志查看

查看应用日志以获取详细错误信息：

```bash
# 查看应用日志
tail -f logs/app.log

# 查看认证日志
tail -f logs/auth.log
```

## 开发说明

### 文件结构

```
├── public/
│   ├── login.html          # 登录页面
│   ├── register.html       # 注册页面
│   ├── js/
│   │   ├── login.js        # 登录页面逻辑
│   │   ├── register.js     # 注册页面逻辑
│   │   └── ui-enhancements.js # UI增强功能
│   └── css/
│       └── modern-enhancements.css # 现代化样式
├── routes/
│   └── auth.js             # 认证路由
├── models/
│   └── User.js             # 用户模型
└── scripts/
    └── migrate-user-data.js # 数据迁移脚本
```

### 扩展开发

如需添加新功能，请确保：
1. 所有API都包含用户身份验证
2. 数据查询都包含用户ID过滤
3. 前端页面都检查登录状态
4. 新增的翻译文本都添加到语言文件中

## 版本信息

- **版本**: 2.0.0
- **更新日期**: 2024年
- **主要变更**: 
  - 添加用户注册和登录功能
  - 实现用户数据隔离
  - 优化界面设计
  - 默认中文显示
  - 增强安全性
